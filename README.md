In hindsight, it could have been done with fewer lines of code.
But this is an early project, and it works. Voila.